import { Directive, EventEmitter, forwardRef, Inject, Input, Output } from '@angular/core';
import { select as d3_select } from 'd3-selection';
import { easeQuadInOut as d3_easeQuadInOut } from 'd3-ease';
import { PbdsDatavizBarGroupedComponent } from './dataviz-bar-grouped.component';
import * as i0 from "@angular/core";
const ANNOTATION_MARGIN_TOP = 62;
const ANNOTATION_OFFSET = -22;
const ANNOTATION_COMMENT_OFFSET = -47;
const TRANSITION_DURATION = 1000;
const TRANSITION_DELAY = 500;
export class PbdsBarGroupedAnnotationsDirective {
    constructor(component) {
        this.component = component;
        this.annotationsHilight = null;
        this.annotationClicked = new EventEmitter();
        component.marginTop = ANNOTATION_MARGIN_TOP;
    }
    ngOnInit() {
        this.annotationsGroup = this.component.svg.append('g').attr('class', 'annotations');
        this.hilightBox = this.annotationsGroup
            .append('rect')
            .classed('annotations-hilight', true)
            .attr('opacity', 0)
            .attr('width', this.component.xAxisScale.bandwidth())
            .attr('height', this.component.height)
            .attr('transform', `translate(${0}, ${0})`);
        this.update();
    }
    ngOnChanges(changes) {
        if (changes && changes.annotationsHilight && !changes.annotationsHilight.firstChange) {
            if (changes.annotationsHilight.currentValue) {
                this.updateHilight();
            }
            else {
                this.hilightBox.transition().duration(200).attr('opacity', 0);
            }
        }
        if (changes.annotations && !changes.annotations.firstChange) {
            this.update();
        }
    }
    update() {
        const isAnotations = this.annotations;
        const isIncidents = this.annotations?.incidents?.length > 0;
        const isComments = this.annotations?.comments?.length > 0;
        if (isAnotations && isIncidents) {
            const bandwidth = this.component.xAxisScale.bandwidth();
            this.annotationsGroup
                .selectAll('g.incident')
                .data(this.annotations.incidents)
                .join((enter) => {
                const g = enter.append('g').attr('class', 'incident');
                g.attr('transform', (d, i) => {
                    const x = this.component.xAxisScale(d.key) + bandwidth / 2;
                    const y = ANNOTATION_OFFSET;
                    return `translate(${x}, ${y})`;
                }).attr('index', (d, i) => i);
                g.append('circle')
                    .attr('r', 0)
                    .attr('cx', 0)
                    .attr('cy', 0)
                    .transition()
                    .duration(TRANSITION_DURATION)
                    .ease(d3_easeQuadInOut)
                    .attr('r', 15);
                g.append('text')
                    .attr('x', 0)
                    .attr('y', 0)
                    .attr('dx', 1)
                    .attr('dy', 9)
                    .attr('text-anchor', 'middle')
                    .text((d) => {
                    return d.icon || '';
                })
                    .attr('style', 'font-size: 0')
                    .transition()
                    .duration(TRANSITION_DURATION)
                    .ease(d3_easeQuadInOut)
                    .attr('style', 'font-size: 17px');
                return g;
            }, (update) => {
                update
                    .transition()
                    .duration(TRANSITION_DURATION)
                    .ease(d3_easeQuadInOut)
                    .attr('transform', (d) => {
                    const x = this.component.xAxisScale(d.key) + bandwidth / 2;
                    const y = ANNOTATION_OFFSET;
                    return `translate(${x}, ${y})`;
                });
                return update;
            }, (exit) => {
                exit.select('circle').transition().duration(TRANSITION_DURATION).attr('r', 0);
                exit.select('text').transition().duration(TRANSITION_DURATION).attr('style', 'font-size: 0');
                return exit.transition().delay(TRANSITION_DELAY).remove();
            })
                .on('mouseover', (event, data) => {
                d3_select(event.currentTarget).classed('hovered', true);
            })
                .on('mouseout', (event, data) => {
                d3_select(event.currentTarget).classed('hovered', false);
            })
                .on('click', (event, data) => {
                // console.log('incident clicked', this.index.get(event.currentTarget.node));
                this.annotationClicked.emit({ event, data, index: +d3_select(event.currentTarget).attr('index') });
            });
        }
        if (isAnotations && isComments) {
            const bandwidth = this.component.xAxisScale.bandwidth();
            this.annotationsGroup
                .selectAll('g.comment')
                .data(this.annotations.comments)
                .join((enter) => {
                const g = enter.append('g').attr('class', 'comment');
                g.attr('transform', (d) => {
                    const x = this.component.xAxisScale(d.key) + bandwidth / 2;
                    let y = ANNOTATION_OFFSET;
                    const isIncidents = this.annotations?.incidents?.some((incident) => incident.key === d.key);
                    if (isIncidents) {
                        y = ANNOTATION_COMMENT_OFFSET;
                    }
                    return `translate(${x}, ${y})`;
                }).attr('index', (d, i) => i);
                g.append('circle')
                    .attr('r', 0)
                    .attr('cx', 0)
                    .attr('cy', 0)
                    .transition()
                    .duration(TRANSITION_DURATION)
                    .ease(d3_easeQuadInOut)
                    .attr('r', 15);
                g.append('text')
                    .attr('x', 0)
                    .attr('y', 3)
                    .attr('dx', 0)
                    .attr('dy', 5)
                    .attr('text-anchor', 'middle')
                    .text('')
                    .attr('style', 'font-size: 0')
                    .transition()
                    .duration(TRANSITION_DURATION)
                    .ease(d3_easeQuadInOut)
                    .attr('style', 'font-size: 17px');
                return g;
            }, (update) => {
                update
                    .transition()
                    .duration(TRANSITION_DURATION)
                    .ease(d3_easeQuadInOut)
                    .attr('transform', (d) => {
                    const x = this.component.xAxisScale(d.key) + bandwidth / 2;
                    let y = ANNOTATION_OFFSET;
                    const isIncidents = this.annotations?.incidents?.some((incident) => incident.key === d.key);
                    if (isIncidents) {
                        y = ANNOTATION_COMMENT_OFFSET;
                    }
                    return `translate(${x}, ${y})`;
                });
                return update;
            }, (exit) => {
                exit.select('circle').transition().duration(TRANSITION_DURATION).attr('r', 0);
                exit.select('text').transition().duration(TRANSITION_DURATION).attr('style', 'font-size: 0');
                return exit.transition().delay(TRANSITION_DELAY).remove();
            })
                .on('mouseover', (event) => {
                d3_select(event.currentTarget).classed('hovered', true);
            })
                .on('mouseout', (event) => {
                d3_select(event.currentTarget).classed('hovered', false);
            })
                .on('click', (event, data) => {
                this.annotationClicked.emit({ event, data, index: +d3_select(event.currentTarget).attr('index') });
            });
        }
        // hilight
        if (this.annotationsHilight) {
            this.updateHilight();
        }
        this.component.svg.selectAll('.bar').classed('pbds-annotation-add', true);
    }
    updateHilight() {
        const opacity = this.hilightBox.attr('opacity');
        const duration = opacity === 0 ? 0 : 300;
        this.hilightBox
            .transition()
            .duration(duration)
            .ease(d3_easeQuadInOut)
            .attr('transform', () => {
            const x = this.component.xAxisScale(this.annotationsHilight);
            const y = 0;
            return `translate(${x}, ${y})`;
        })
            .transition()
            .duration(200)
            .attr('opacity', 1);
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: PbdsBarGroupedAnnotationsDirective, deps: [{ token: forwardRef(() => PbdsDatavizBarGroupedComponent) }], target: i0.ɵɵFactoryTarget.Directive }); }
    static { this.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "14.0.0", version: "16.2.12", type: PbdsBarGroupedAnnotationsDirective, selector: "pbds-dataviz-bar-grouped[annotations]", inputs: { annotations: "annotations", annotationsHilight: "annotationsHilight" }, outputs: { annotationClicked: "annotationClicked" }, usesOnChanges: true, ngImport: i0 }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: PbdsBarGroupedAnnotationsDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: 'pbds-dataviz-bar-grouped[annotations]'
                }]
        }], ctorParameters: function () { return [{ type: undefined, decorators: [{
                    type: Inject,
                    args: [forwardRef(() => PbdsDatavizBarGroupedComponent)]
                }] }]; }, propDecorators: { annotations: [{
                type: Input,
                args: ['annotations']
            }], annotationsHilight: [{
                type: Input,
                args: ['annotationsHilight']
            }], annotationClicked: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YXZpei1iYXItZ3JvdXBlZC1hbm5vdGF0aW9ucy5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9wYi1kZXNpZ24tc3lzdGVtL2RhdGF2aXovZGF0YXZpei1iYXItZ3JvdXBlZC1hbm5vdGF0aW9ucy5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLFNBQVMsRUFDVCxZQUFZLEVBQ1osVUFBVSxFQUNWLE1BQU0sRUFDTixLQUFLLEVBR0wsTUFBTSxFQUVQLE1BQU0sZUFBZSxDQUFDO0FBRXZCLE9BQU8sRUFBRSxNQUFNLElBQUksU0FBUyxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQ25ELE9BQU8sRUFBRSxhQUFhLElBQUksZ0JBQWdCLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFFNUQsT0FBTyxFQUFFLDhCQUE4QixFQUFFLE1BQU0saUNBQWlDLENBQUM7O0FBRWpGLE1BQU0scUJBQXFCLEdBQUcsRUFBRSxDQUFDO0FBQ2pDLE1BQU0saUJBQWlCLEdBQUcsQ0FBQyxFQUFFLENBQUM7QUFDOUIsTUFBTSx5QkFBeUIsR0FBRyxDQUFDLEVBQUUsQ0FBQztBQUN0QyxNQUFNLG1CQUFtQixHQUFHLElBQUksQ0FBQztBQUNqQyxNQUFNLGdCQUFnQixHQUFHLEdBQUcsQ0FBQztBQUs3QixNQUFNLE9BQU8sa0NBQWtDO0lBVTdDLFlBQThFLFNBQVM7UUFBVCxjQUFTLEdBQVQsU0FBUyxDQUFBO1FBUDFELHVCQUFrQixHQUFHLElBQUksQ0FBQztRQUU3QyxzQkFBaUIsR0FBc0IsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQU1sRSxTQUFTLENBQUMsU0FBUyxHQUFHLHFCQUFxQixDQUFDO0lBQzlDLENBQUM7SUFFRCxRQUFRO1FBQ04sSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJ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QUFDLENBQUM7WUFDN0QsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBRVosT0FBTyxhQUFhLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQztRQUNqQyxDQUFDLENBQUM7YUFDRCxVQUFVLEVBQUU7YUFDWixRQUFRLENBQUMsR0FBRyxDQUFDO2FBQ2IsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUN4QixDQUFDOytHQTFPVSxrQ0FBa0Msa0JBVXpCLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyw4QkFBOEIsQ0FBQzttR0FWekQsa0NBQWtDOzs0RkFBbEMsa0NBQWtDO2tCQUg5QyxTQUFTO21CQUFDO29CQUNULFFBQVEsRUFBRSx1Q0FBdUM7aUJBQ2xEOzswQkFXYyxNQUFNOzJCQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyw4QkFBOEIsQ0FBQzs0Q0FUOUMsV0FBVztzQkFBaEMsS0FBSzt1QkFBQyxhQUFhO2dCQUVTLGtCQUFrQjtzQkFBOUMsS0FBSzt1QkFBQyxvQkFBb0I7Z0JBRWpCLGlCQUFpQjtzQkFBMUIsTUFBTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIERpcmVjdGl2ZSxcbiAgRXZlbnRFbWl0dGVyLFxuICBmb3J3YXJkUmVmLFxuICBJbmplY3QsXG4gIElucHV0LFxuICBPbkNoYW5nZXMsXG4gIE9uSW5pdCxcbiAgT3V0cHV0LFxuICBTaW1wbGVDaGFuZ2VzXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBzZWxlY3QgYXMgZDNfc2VsZWN0IH0gZnJvbSAnZDMtc2VsZWN0aW9uJztcbmltcG9ydCB7IGVhc2VRdWFkSW5PdXQgYXMgZDNfZWFzZVF1YWRJbk91dCB9IGZyb20gJ2QzLWVhc2UnO1xuXG5pbXBvcnQgeyBQYmRzRGF0YXZpekJhckdyb3VwZWRDb21wb25lbnQgfSBmcm9tICcuL2RhdGF2aXotYmFyLWdyb3VwZWQuY29tcG9uZW50JztcblxuY29uc3QgQU5OT1RBVElPTl9NQVJHSU5fVE9QID0gNjI7XG5jb25zdCBBTk5PVEFUSU9OX09GRlNFVCA9IC0yMjtcbmNvbnN0IEFOTk9UQVRJT05fQ09NTUVOVF9PRkZTRVQgPSAtNDc7XG5jb25zdCBUUkFOU0lUSU9OX0RVUkFUSU9OID0gMTAwMDtcbmNvbnN0IFRSQU5TSVRJT05fREVMQVkgPSA1MDA7XG5cbkBEaXJlY3RpdmUoe1xuICBzZWxlY3RvcjogJ3BiZHMtZGF0YXZpei1iYXItZ3JvdXBlZFthbm5vdGF0aW9uc10nXG59KVxuZXhwb3J0IGNsYXNzIFBiZHNCYXJHcm91cGVkQW5ub3RhdGlvbnNEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIE9uQ2hhbmdlcyB7XG4gIEBJbnB1dCgnYW5ub3RhdGlvbnMnKSBhbm5vdGF0aW9ucztcblxuICBASW5wdXQoJ2Fubm90YXRpb25zSGlsaWdodCcpIGFubm90YXRpb25zSGlsaWdodCA9IG51bGw7XG5cbiAgQE91dHB1dCgpIGFubm90YXRpb25DbGlja2VkOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICBwcml2YXRlIGFubm90YXRpb25zR3JvdXA7XG4gIHByaXZhdGUgaGlsaWdodEJveDtcblxuICBjb25zdHJ1Y3RvcihASW5qZWN0KGZvcndhcmRSZWYoKCkgPT4gUGJkc0RhdGF2aXpCYXJHcm91cGVkQ29tcG9uZW50KSkgcHJpdmF0ZSBjb21wb25lbnQpIHtcbiAgICBjb21wb25lbnQubWFyZ2luVG9wID0gQU5OT1RBVElPTl9NQVJHSU5fVE9QO1xuICB9XG5cbiAgbmdPbkluaXQoKTogdm9pZCB7XG4gICAgdGhpcy5hbm5vdGF0aW9uc0dyb3VwID0gdGhpcy5jb21wb25lbnQuc3ZnLmFwcGVuZCgnZycpLmF0dHIoJ2NsYXNzJywgJ2Fubm90YXRpb25zJyk7XG5cbiAgICB0aGlzLmhpbGlnaHRCb3ggPSB0aGlzLmFubm90YXRpb25zR3JvdXBcbiAgICAgIC5hcHBlbmQoJ3JlY3QnKVxuICAgICAgLmNsYXNzZWQoJ2Fubm90YXRpb25zLWhpbGlnaHQnLCB0cnVlKVxuICAgICAgLmF0dHIoJ29wYWNpdHknLCAwKVxuICAgICAgLmF0dHIoJ3dpZHRoJywgdGhpcy5jb21wb25lbnQueEF4aXNTY2FsZS5iYW5kd2lkdGgoKSlcbiAgICAgIC5hdHRyKCdoZWlnaHQnLCB0aGlzLmNvbXBvbmVudC5oZWlnaHQpXG4gICAgICAuYXR0cigndHJhbnNmb3JtJywgYHRyYW5zbGF0ZSgkezB9LCAkezB9KWApO1xuXG4gICAgdGhpcy51cGRhdGUoKTtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcbiAgICBpZiAoY2hhbmdlcyAmJiBjaGFuZ2VzLmFubm90YXRpb25zSGlsaWdodCAmJiAhY2hhbmdlcy5hbm5vdGF0aW9uc0hpbGlnaHQuZmlyc3RDaGFuZ2UpIHtcbiAgICAgIGlmIChjaGFuZ2VzLmFubm90YXRpb25zSGlsaWdodC5jdXJyZW50VmFsdWUpIHtcbiAgICAgICAgdGhpcy51cGRhdGVIaWxpZ2h0KCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmhpbGlnaHRCb3gudHJhbnNpdGlvbigpLmR1cmF0aW9uKDIwMCkuYXR0cignb3BhY2l0eScsIDApO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChjaGFuZ2VzLmFubm90YXRpb25zICYmICFjaGFuZ2VzLmFubm90YXRpb25zLmZpcnN0Q2hhbmdlKSB7XG4gICAgICB0aGlzLnVwZGF0ZSgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlKCkge1xuICAgIGNvbnN0IGlzQW5vdGF0aW9ucyA9IHRoaXMuYW5ub3RhdGlvbnM7XG4gICAgY29uc3QgaXNJbmNpZGVudHMgPSB0aGlzLmFubm90YXRpb25zPy5pbmNpZGVudHM/Lmxlbmd0aCA+IDA7XG4gICAgY29uc3QgaXNDb21tZW50cyA9IHRoaXMuYW5ub3RhdGlvbnM/LmNvbW1lbnRzPy5sZW5ndGggPiAwO1xuXG4gICAgaWYgKGlzQW5vdGF0aW9ucyAmJiBpc0luY2lkZW50cykge1xuICAgICAgY29uc3QgYmFuZHdpZHRoID0gdGhpcy5jb21wb25lbnQueEF4aXNTY2FsZS5iYW5kd2lkdGgoKTtcblxuICAgICAgdGhpcy5hbm5vdGF0aW9uc0dyb3VwXG4gICAgICAgIC5zZWxlY3RBbGwoJ2cuaW5jaWRlbnQnKVxuICAgICAgICAuZGF0YSh0aGlzLmFubm90YXRpb25zLmluY2lkZW50cylcbiAgICAgICAgLmpvaW4oXG4gICAgICAgICAgKGVudGVyKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBnID0gZW50ZXIuYXBwZW5kKCdnJykuYXR0cignY2xhc3MnLCAnaW5jaWRlbnQnKTtcblxuICAgICAgICAgICAgZy5hdHRyKCd0cmFuc2Zvcm0nLCAoZCwgaSkgPT4ge1xuICAgICAgICAgICAgICBjb25zdCB4ID0gdGhpcy5jb21wb25lbnQueEF4aXNTY2FsZShkLmtleSkgKyBiYW5kd2lkdGggLyAyO1xuICAgICAgICAgICAgICBjb25zdCB5ID0gQU5OT1RBVElPTl9PRkZTRVQ7XG5cbiAgICAgICAgICAgICAgcmV0dXJuIGB0cmFuc2xhdGUoJHt4fSwgJHt5fSlgO1xuICAgICAgICAgICAgfSkuYXR0cignaW5kZXgnLCAoZCwgaSkgPT4gaSk7XG5cbiAgICAgICAgICAgIGcuYXBwZW5kKCdjaXJjbGUnKVxuICAgICAgICAgICAgICAuYXR0cigncicsIDApXG4gICAgICAgICAgICAgIC5hdHRyKCdjeCcsIDApXG4gICAgICAgICAgICAgIC5hdHRyKCdjeScsIDApXG4gICAgICAgICAgICAgIC50cmFuc2l0aW9uKClcbiAgICAgICAgICAgICAgLmR1cmF0aW9uKFRSQU5TSVRJT05fRFVSQVRJT04pXG4gICAgICAgICAgICAgIC5lYXNlKGQzX2Vhc2VRdWFkSW5PdXQpXG4gICAgICAgICAgICAgIC5hdHRyKCdyJywgMTUpO1xuXG4gICAgICAgICAgICBnLmFwcGVuZCgndGV4dCcpXG4gICAgICAgICAgICAgIC5hdHRyKCd4JywgMClcbiAgICAgICAgICAgICAgLmF0dHIoJ3knLCAwKVxuICAgICAgICAgICAgICAuYXR0cignZHgnLCAxKVxuICAgICAgICAgICAgICAuYXR0cignZHknLCA5KVxuICAgICAgICAgICAgICAuYXR0cigndGV4dC1hbmNob3InLCAnbWlkZGxlJylcbiAgICAgICAgICAgICAgLnRleHQoKGQpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZC5pY29uIHx8ICfuqYEnO1xuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAuYXR0cignc3R5bGUnLCAnZm9udC1zaXplOiAwJylcbiAgICAgICAgICAgICAgLnRyYW5zaXRpb24oKVxuICAgICAgICAgICAgICAuZHVyYXRpb24oVFJBTlNJVElPTl9EVVJBVElPTilcbiAgICAgICAgICAgICAgLmVhc2UoZDNfZWFzZVF1YWRJbk91dClcbiAgICAgICAgICAgICAgLmF0dHIoJ3N0eWxlJywgJ2ZvbnQtc2l6ZTogMTdweCcpO1xuXG4gICAgICAgICAgICByZXR1cm4gZztcbiAgICAgICAgICB9LFxuICAgICAgICAgICh1cGRhdGUpID0+IHtcbiAgICAgICAgICAgIHVwZGF0ZVxuICAgICAgICAgICAgICAudHJhbnNpdGlvbigpXG4gICAgICAgICAgICAgIC5kdXJhdGlvbihUUkFOU0lUSU9OX0RVUkFUSU9OKVxuICAgICAgICAgICAgICAuZWFzZShkM19lYXNlUXVhZEluT3V0KVxuICAgICAgICAgICAgICAuYXR0cigndHJhbnNmb3JtJywgKGQpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCB4ID0gdGhpcy5jb21wb25lbnQueEF4aXNTY2FsZShkLmtleSkgKyBiYW5kd2lkdGggLyAyO1xuICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBBTk5PVEFUSU9OX09GRlNFVDtcblxuICAgICAgICAgICAgICAgIHJldHVybiBgdHJhbnNsYXRlKCR7eH0sICR7eX0pYDtcbiAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHJldHVybiB1cGRhdGU7XG4gICAgICAgICAgfSxcbiAgICAgICAgICAoZXhpdCkgPT4ge1xuICAgICAgICAgICAgZXhpdC5zZWxlY3QoJ2NpcmNsZScpLnRyYW5zaXRpb24oKS5kdXJhdGlvbihUUkFOU0lUSU9OX0RVUkFUSU9OKS5hdHRyKCdyJywgMCk7XG5cbiAgICAgICAgICAgIGV4aXQuc2VsZWN0KCd0ZXh0JykudHJhbnNpdGlvbigpLmR1cmF0aW9uKFRSQU5TSVRJT05fRFVSQVRJT04pLmF0dHIoJ3N0eWxlJywgJ2ZvbnQtc2l6ZTogMCcpO1xuXG4gICAgICAgICAgICByZXR1cm4gZXhpdC50cmFuc2l0aW9uKCkuZGVsYXkoVFJBTlNJVElPTl9ERUxBWSkucmVtb3ZlKCk7XG4gICAgICAgICAgfVxuICAgICAgICApXG4gICAgICAgIC5vbignbW91c2VvdmVyJywgKGV2ZW50LCBkYXRhKSA9PiB7XG4gICAgICAgICAgZDNfc2VsZWN0KGV2ZW50LmN1cnJlbnRUYXJnZXQpLmNsYXNzZWQoJ2hvdmVyZWQnLCB0cnVlKTtcbiAgICAgICAgfSlcbiAgICAgICAgLm9uKCdtb3VzZW91dCcsIChldmVudCwgZGF0YSkgPT4ge1xuICAgICAgICAgIGQzX3NlbGVjdChldmVudC5jdXJyZW50VGFyZ2V0KS5jbGFzc2VkKCdob3ZlcmVkJywgZmFsc2UpO1xuICAgICAgICB9KVxuICAgICAgICAub24oJ2NsaWNrJywgKGV2ZW50LCBkYXRhKSA9PiB7XG4gICAgICAgICAgLy8gY29uc29sZS5sb2coJ2luY2lkZW50IGNsaWNrZWQnLCB0aGlzLmluZGV4LmdldChldmVudC5jdXJyZW50VGFyZ2V0Lm5vZGUpKTtcbiAgICAgICAgICB0aGlzLmFubm90YXRpb25DbGlja2VkLmVtaXQoeyBldmVudCwgZGF0YSwgaW5kZXg6ICtkM19zZWxlY3QoZXZlbnQuY3VycmVudFRhcmdldCkuYXR0cignaW5kZXgnKSB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKGlzQW5vdGF0aW9ucyAmJiBpc0NvbW1lbnRzKSB7XG4gICAgICBjb25zdCBiYW5kd2lkdGggPSB0aGlzLmNvbXBvbmVudC54QXhpc1NjYWxlLmJhbmR3aWR0aCgpO1xuXG4gICAgICB0aGlzLmFubm90YXRpb25zR3JvdXBcbiAgICAgICAgLnNlbGVjdEFsbCgnZy5jb21tZW50JylcbiAgICAgICAgLmRhdGEodGhpcy5hbm5vdGF0aW9ucy5jb21tZW50cylcbiAgICAgICAgLmpvaW4oXG4gICAgICAgICAgKGVudGVyKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBnID0gZW50ZXIuYXBwZW5kKCdnJykuYXR0cignY2xhc3MnLCAnY29tbWVudCcpO1xuXG4gICAgICAgICAgICBnLmF0dHIoJ3RyYW5zZm9ybScsIChkKSA9PiB7XG4gICAgICAgICAgICAgIGNvbnN0IHggPSB0aGlzLmNvbXBvbmVudC54QXhpc1NjYWxlKGQua2V5KSArIGJhbmR3aWR0aCAvIDI7XG4gICAgICAgICAgICAgIGxldCB5ID0gQU5OT1RBVElPTl9PRkZTRVQ7XG4gICAgICAgICAgICAgIGNvbnN0IGlzSW5jaWRlbnRzID0gdGhpcy5hbm5vdGF0aW9ucz8uaW5jaWRlbnRzPy5zb21lKChpbmNpZGVudCkgPT4gaW5jaWRlbnQua2V5ID09PSBkLmtleSk7XG5cbiAgICAgICAgICAgICAgaWYgKGlzSW5jaWRlbnRzKSB7XG4gICAgICAgICAgICAgICAgeSA9IEFOTk9UQVRJT05fQ09NTUVOVF9PRkZTRVQ7XG4gICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICByZXR1cm4gYHRyYW5zbGF0ZSgke3h9LCAke3l9KWA7XG4gICAgICAgICAgICB9KS5hdHRyKCdpbmRleCcsIChkLCBpKSA9PiBpKTtcblxuICAgICAgICAgICAgZy5hcHBlbmQoJ2NpcmNsZScpXG4gICAgICAgICAgICAgIC5hdHRyKCdyJywgMClcbiAgICAgICAgICAgICAgLmF0dHIoJ2N4JywgMClcbiAgICAgICAgICAgICAgLmF0dHIoJ2N5JywgMClcbiAgICAgICAgICAgICAgLnRyYW5zaXRpb24oKVxuICAgICAgICAgICAgICAuZHVyYXRpb24oVFJBTlNJVElPTl9EVVJBVElPTilcbiAgICAgICAgICAgICAgLmVhc2UoZDNfZWFzZVF1YWRJbk91dClcbiAgICAgICAgICAgICAgLmF0dHIoJ3InLCAxNSk7XG5cbiAgICAgICAgICAgIGcuYXBwZW5kKCd0ZXh0JylcbiAgICAgICAgICAgICAgLmF0dHIoJ3gnLCAwKVxuICAgICAgICAgICAgICAuYXR0cigneScsIDMpXG4gICAgICAgICAgICAgIC5hdHRyKCdkeCcsIDApXG4gICAgICAgICAgICAgIC5hdHRyKCdkeScsIDUpXG4gICAgICAgICAgICAgIC5hdHRyKCd0ZXh0LWFuY2hvcicsICdtaWRkbGUnKVxuICAgICAgICAgICAgICAudGV4dCgn7qq8JylcbiAgICAgICAgICAgICAgLmF0dHIoJ3N0eWxlJywgJ2ZvbnQtc2l6ZTogMCcpXG4gICAgICAgICAgICAgIC50cmFuc2l0aW9uKClcbiAgICAgICAgICAgICAgLmR1cmF0aW9uKFRSQU5TSVRJT05fRFVSQVRJT04pXG4gICAgICAgICAgICAgIC5lYXNlKGQzX2Vhc2VRdWFkSW5PdXQpXG4gICAgICAgICAgICAgIC5hdHRyKCdzdHlsZScsICdmb250LXNpemU6IDE3cHgnKTtcblxuICAgICAgICAgICAgcmV0dXJuIGc7XG4gICAgICAgICAgfSxcbiAgICAgICAgICAodXBkYXRlKSA9PiB7XG4gICAgICAgICAgICB1cGRhdGVcbiAgICAgICAgICAgICAgLnRyYW5zaXRpb24oKVxuICAgICAgICAgICAgICAuZHVyYXRpb24oVFJBTlNJVElPTl9EVVJBVElPTilcbiAgICAgICAgICAgICAgLmVhc2UoZDNfZWFzZVF1YWRJbk91dClcbiAgICAgICAgICAgICAgLmF0dHIoJ3RyYW5zZm9ybScsIChkKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgeCA9IHRoaXMuY29tcG9uZW50LnhBeGlzU2NhbGUoZC5rZXkpICsgYmFuZHdpZHRoIC8gMjtcbiAgICAgICAgICAgICAgICBsZXQgeSA9IEFOTk9UQVRJT05fT0ZGU0VUO1xuICAgICAgICAgICAgICAgIGNvbnN0IGlzSW5jaWRlbnRzID0gdGhpcy5hbm5vdGF0aW9ucz8uaW5jaWRlbnRzPy5zb21lKChpbmNpZGVudCkgPT4gaW5jaWRlbnQua2V5ID09PSBkLmtleSk7XG5cbiAgICAgICAgICAgICAgICBpZiAoaXNJbmNpZGVudHMpIHtcbiAgICAgICAgICAgICAgICAgIHkgPSBBTk5PVEFUSU9OX0NPTU1FTlRfT0ZGU0VUO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiBgdHJhbnNsYXRlKCR7eH0sICR7eX0pYDtcbiAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHJldHVybiB1cGRhdGU7XG4gICAgICAgICAgfSxcbiAgICAgICAgICAoZXhpdCkgPT4ge1xuICAgICAgICAgICAgZXhpdC5zZWxlY3QoJ2NpcmNsZScpLnRyYW5zaXRpb24oKS5kdXJhdGlvbihUUkFOU0lUSU9OX0RVUkFUSU9OKS5hdHRyKCdyJywgMCk7XG5cbiAgICAgICAgICAgIGV4aXQuc2VsZWN0KCd0ZXh0JykudHJhbnNpdGlvbigpLmR1cmF0aW9uKFRSQU5TSVRJT05fRFVSQVRJT04pLmF0dHIoJ3N0eWxlJywgJ2ZvbnQtc2l6ZTogMCcpO1xuXG4gICAgICAgICAgICByZXR1cm4gZXhpdC50cmFuc2l0aW9uKCkuZGVsYXkoVFJBTlNJVElPTl9ERUxBWSkucmVtb3ZlKCk7XG4gICAgICAgICAgfVxuICAgICAgICApXG4gICAgICAgIC5vbignbW91c2VvdmVyJywgKGV2ZW50KSA9PiB7XG4gICAgICAgICAgZDNfc2VsZWN0KGV2ZW50LmN1cnJlbnRUYXJnZXQpLmNsYXNzZWQoJ2hvdmVyZWQnLCB0cnVlKTtcbiAgICAgICAgfSlcbiAgICAgICAgLm9uKCdtb3VzZW91dCcsIChldmVudCkgPT4ge1xuICAgICAgICAgIGQzX3NlbGVjdChldmVudC5jdXJyZW50VGFyZ2V0KS5jbGFzc2VkKCdob3ZlcmVkJywgZmFsc2UpO1xuICAgICAgICB9KVxuICAgICAgICAub24oJ2NsaWNrJywgKGV2ZW50LCBkYXRhKSA9PiB7XG4gICAgICAgICAgdGhpcy5hbm5vdGF0aW9uQ2xpY2tlZC5lbWl0KHsgZXZlbnQsIGRhdGEsIGluZGV4OiArZDNfc2VsZWN0KGV2ZW50LmN1cnJlbnRUYXJnZXQpLmF0dHIoJ2luZGV4JykgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIGhpbGlnaHRcbiAgICBpZiAodGhpcy5hbm5vdGF0aW9uc0hpbGlnaHQpIHtcbiAgICAgIHRoaXMudXBkYXRlSGlsaWdodCgpO1xuICAgIH1cblxuICAgIHRoaXMuY29tcG9uZW50LnN2Zy5zZWxlY3RBbGwoJy5iYXInKS5jbGFzc2VkKCdwYmRzLWFubm90YXRpb24tYWRkJywgdHJ1ZSk7XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZUhpbGlnaHQoKSB7XG4gICAgY29uc3Qgb3BhY2l0eSA9IHRoaXMuaGlsaWdodEJveC5hdHRyKCdvcGFjaXR5Jyk7XG5cbiAgICBjb25zdCBkdXJhdGlvbiA9IG9wYWNpdHkgPT09IDAgPyAwIDogMzAwO1xuXG4gICAgdGhpcy5oaWxpZ2h0Qm94XG4gICAgICAudHJhbnNpdGlvbigpXG4gICAgICAuZHVyYXRpb24oZHVyYXRpb24pXG4gICAgICAuZWFzZShkM19lYXNlUXVhZEluT3V0KVxuICAgICAgLmF0dHIoJ3RyYW5zZm9ybScsICgpID0+IHtcbiAgICAgICAgY29uc3QgeCA9IHRoaXMuY29tcG9uZW50LnhBeGlzU2NhbGUodGhpcy5hbm5vdGF0aW9uc0hpbGlnaHQpO1xuICAgICAgICBjb25zdCB5ID0gMDtcblxuICAgICAgICByZXR1cm4gYHRyYW5zbGF0ZSgke3h9LCAke3l9KWA7XG4gICAgICB9KVxuICAgICAgLnRyYW5zaXRpb24oKVxuICAgICAgLmR1cmF0aW9uKDIwMClcbiAgICAgIC5hdHRyKCdvcGFjaXR5JywgMSk7XG4gIH1cbn1cbiJdfQ==